---
title: "sample_calculation.Rmd"
date: "`r Sys.Date()`"
output:
  html_document:
    toc: true
    toc_depth: 3
    toc_float: true
  word_document:
    toc: true
    toc_depth: '3'
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

# Список библиотек для установки, если их нет
libraries_to_install <- c("tidyverse", "ggplot2", "rstatix", "broom", "gtsummary", "dplyr")

# Проверка и установка библиотек
for (library_name in libraries_to_install) {
  if (!requireNamespace(library_name, quietly = TRUE)) {
    install.packages(library_name, dependencies = TRUE)
  }
}

library(tidyverse)
library(ggplot2)
library(rstatix)
library(broom)
library(gtsummary)
library(dplyr)
```

# EDA 

```{r}
data <- read.csv2("../data/team_5.csv")
data_filtered <- data %>%
  mutate_if(is.character, as.factor) %>%
  mutate(
    V0_DEM_GEN = factor("ж"),
    V0_DEM_AGE = V0_DEM_AGE + 20
  ) %>%
   mutate_at(vars(contains('NORM')), as.factor)

non_unique <- names(data_filtered)[sapply(data_filtered, function(x) length(unique(x)) == 1)]

data_filtered <- data_filtered %>% select(-all_of(non_unique))
data_filtered %>% glimpse()
```
# 1. Введение 
Постменопаузальный синдром с приливами является распространенным явлением у женщин после менопаузы. Приливы могут влиять на качество жизни и часто становятся причиной обращения к врачу. Приливы представляют внезапное ощущение тепла в верхней части тела, которое обычно распространяется наиболее интенсивно на лицо, шею и грудь. При этом кожа может покраснеть. Вот несколько общих фактов:

- Распространенность: Большинство женщин (около 75-85%) испытывают приливы во время постменопаузы.
- Длительность симптомов: Приливы могут продолжаться в течение нескольких лет после установления менопаузы.
- Интенсивность: Симптомы могут варьировать от легких до тяжелых, влияя на ежедневную активность и сон.
- Влияние на качество жизни: Приливы могут существенно повлиять на физическое и эмоциональное благополучие женщин.
Существующая терапия для лечения постменопаузального синдрома с приливами:
- Гормональная терапия: Пациентам может быть предложена гормональная заместительная терапия для компенсации снижения уровня эстрогенов.
- Изменения в образе жизни: Регулярные физические упражнения, здоровое питание и управление стрессом могут снизить частоту и интенсивность приливов.
- Препараты без гормонов: Некоторые женщины предпочитают использовать альтернативные методы, такие как препараты без гормонов или натуральные средства.
Некоторым женщинам нельзя применять гормональную терапию, поэтому разрабатываются альтернативные лекарственные препараты, которые могли бы улучшить качество жизни женщин в постменопаузальный период с приливами. 

## 1.1 Терапевтическая зона препарата 

Мастодинон®, капли для приема внутрь планируется использовать в гинекологической терапевтической зоне

## 1.2 Ключевые особенности клинического исследования

Точки оценки эффективности и безопасности/

Оценка эффективности проводилась путем сравнения количества приливов в 2 группах(контрольная группа и группа плацебо) до начала приема препарата и после терапии

Безопасность терапии оценивалась путем сравнения показателей EGC, VIT(АД, ЧСС, ЧДД), АОК до начала приема терапии и после 

Количество субъектов - 52 

Данное исследование был направлено на расширение показаний для применения препарата Мастодинон®. Согласно справочнику VIDAL в настоящее время показания препарата не включают постменопаузальный синдром, в частности, сопровождающийся приливами. По данным литературы (Abaspoor Z., 2011) аналог данного препарата Vitex agnus-castus был ранее успешно применен для лечения постменопаузального синдрома. В представленном исследовании предлагается расширение целевой возрастной группы по сравнению с Vitex agnus-castus с 45-60 лет до 40-60 лет. 

# 2. Цели и задачи исследования 

Целью данного исследования является оценка превосходящей терапевтической эффективности и безопасности препарата Мастодинон®, капли для приема внутрь, и плацебо при лечении постменопаузального синдрома, сопровождающегося приливами

Основная задача:
Изучение превосходящей терапевтической эффективности препарата Мастодинон® и плацебо при лечении постменопаузального синдрома, сопровождающегося приливами, оцениваемыми по количеству приливов в сутки.

Дополнительные задачи:
Оценка общей длительности периодов приливов в течение суток;
Оценка доли случаев, в которых снижение суммы баллов по опроснику Куппермана составило 25% и более по сравнению с исходной суммой баллов на визите 1 (День 0);
Оценка степени снижения систолического и диастолического артериального давления по сравнению с исходными значениями;
Изучение безопасности препарата Мастодинон®, капли для приема внутрь, и плацебо при лечении постменопаузального синдрома, сопровождающегося приливами: оценка нежелательных явлений в группах лечения; сравнение частоты нежелательных явлений в группах лечения.

# 3. План исследования 

## 3.1 Описание дизайна


Описание дизайна:
Проспективное, многоцентровое, рандомизированное, плацебо-контролируемое, двойное слепое клиническое исследование в параллельных группах
Графическая схема-репрезентация 

## 3.2 Обоснование дизайна исследования, в том числе выборка контрольных групп:

Данное исследование проводится в параллельных группах, поскольку такой дизайн исследования минимизирует риск эффекта переноса: одна группа никак не влияет на другую.

## 3.3 Лечение 

### 3.3.1 Описание исследуемого препарата

*Активное вещество:*

100 г препарата содержит: Vitex agnus castus (Agnus castus) D1 20 г; Caulophyllum thalictroides D4 10 г; Cyclamen europaeum (Cyclamen) D4 10 г; Strychnos ignatii (Ignatia) D6 10 г; Iris versicolor (Iris) D2 20 г; Lilium lancifolium (Lilium tigrinum) D3 10 г

*Вспомогательные вещества:*
Этанол 47,0 – 53,0 % (в объёмном отношении).

*Описание:*
Мастодинон® - растительный негормональный препарат
В качестве исследуемого препарата было использовано плацебо для оценки фактической эффективности Мастодинона, также позволяет контролировать эффект плацебо, который может негативно повлиять на результаты исследования 

## 3.4 Выбор популяции

Постменопаузальный синдром с приливами является распространенным явлением у женщин после менопаузы, значительно нарушающим качество жизни. С учетом увеличения распространенности ранней менопаузы в последние годы в исследование будут включаться женщины от 40 до 60 лет включительно с подтвержденным менопаузальным синдромом
В исследование планируется включить (рандомизировать) 52 пациента (по 26 пациентов в каждую группу) с учетом возможного досрочного выбывания 10%. Минимально достаточное для статистического анализа количество пациентов – 46, по 23 пациента в каждую из групп лечения, закончивших исследование по Протоколу.

### 3.4.1 Критерии включения

1. Добровольно подписанное пациентом Информированное согласие на участие в исследовании.

2. Женщины в возрасте от 40 до 60 лет включительно.

3. Наличие диагноза постменопаузального синдрома, сопровождающегося приливами, подтвержденного при осмотре гинекологом не более 3 месяцев до исследования.

4. Отрицательный результат теста на беременность (кроме женщин с длительностью периода менопаузы более 2 лет).

5. Способность понять предоставленную информацию о клиническом исследовании, готовность к соблюдению требований протокола исследования, способность самостоятельно применять препараты исследования и оценивать симптомы с помощью опросников по протоколу.

### 3.4.2 Критерии невключения

Прием эстроген-/прогестерон-содержащих препаратов в течение 6 месяцев до исследования;
Применение глюкокортикостероидов в течение 30 дней до начала исследования и/или планы по применению глюкокортикостероидов в ходе исследования;
Изменение гипотензивной терапии в течение последних 3 месяцев (в т.ч. назначение бета-блокаторов);
Невозможность отмены на период исследования других лекарственных препаратов, способных повлиять на результат настоящего исследования, например, других гомеопатических средств, и/или средств “народной терапии”, либо прием которых несовместим с терапией исследования;
Тяжелое сердечно-сосудистое заболевание или неврологическое заболевание, которое, по мнению врача, не позволяет принять участия в исследовании, в частности:

- тяжелая (стадия IV классификации Канадского Сердечно-Сосудистого Общества (Canadian Cardiovascular Society)) или нестабильная стенокардия;

- декомпенсированная хроническая сердечная недостаточность ( IV степень по NYHA);

- инфаркт миокарда в течение последних 6 месяцев;

- неконтролируемая артериальная гипертензия с систолическим АД > 180 мм рт.ст и/или диастолическим АД > 115 мм рт.ст.

- перенесенное острое нарушение мозгового кровообращения в течение последних 6 месяцев.

Пациенты, участвующие в других клинических исследованиях лекарственных средств на момент Визита скрининга либо участвовавшие в них в течение 30 дней до Визита скрининга;
Пациенты, перенесшие хирургическую операцию в течение 30 дней до Визита скрининга и пациенты, у которых в ходе исследования (до завершения Визита последующего наблюдения) планируется проведение хирургических операций, включая диагностические процедуры, или пребывание в стационаре;
Известная или подозреваемая наркотическая/алкогольная зависимость;
Предполагаемая низкая приверженность пациента лечению или неспособность выполнять процедуры и соблюдать ограничения согласно протоколу исследования (например, вследствие психических заболеваний);
Любые заболевания сердечно-сосудистой системы, почек, печени, ЖКТ, эндокринной и нервной системы или любые другие состояния/заболевания, которые по мнению исследователя могут сделать участие в исследовании небезопасным для пациента.

## 3.5 Описание режима дозирования и введения препаратов

40 капель перорально натощак утром (до завтрака)  ежедневно в течение 4 недель

## 3.6 Метод распределения по группам 

Рандомизация

## 3.7 Последовательность и длительность всех этапов исследования

Периоды исследования:
I. Скрининг + рандомизация:
Визит 1 (День 0)
II. Лечение 
4 недели (28 дней)
III. Контроль эффективности терапии:
Визит 2  (День 29) 

## 3.8 Описание методики оценки конечных точек

### 3.8.1 Оценка первичной точки

Для проверки основной гипотезы исследования в качестве первичной конечной точки выбрано количество приливов в течение 24 часов. Для анализа данной конечной точки планируется построение одностороннего 97.5% доверительного интервала для разницы в средних (двустороннего 95% ДИ). Критерий превосходства определяется условием, при котором нижняя граница 97.5% доверительного интервала для разности средних превышает пороговое значение в 2 прилива в течение 24 часов по сравнению с плацебо. Сравнение групп планируется проводить с помощью  t-критерия Стьюдента для независимых выборок.

### 3.8.2 Оценка вторичных точек 

В исследовании выбраны следующие вторичные конечные точки:

1. Общая длительность периодов приливов в течение 24-х часов (в минутах). 

2. Доля случаев, в которых снижение суммы баллов по опроснику Куппермана составило 25% и более по сравнению с исходной суммой баллов на визите 1.

3. Снижение среднесуточного систолического и диастолического артериального давления по сравнению с исходными значениями в мм рт.ст.

При анализе вторичных конечных точек будут использованы следующие методы:
сравнение частотных переменных будет производиться с помощью критерия хи-квадрат с расчетом отношения шансов;
сравнение величин, относящихся к различным шкалам (баллы по шкале Куппермана) и сравнению длительности будет осуществляться с помощью t-теста.
При описании всех оцениваемых величин, будут представлены как p-значения, так и точечные оценки с соответствующими доверительными интервалами: односторонний 97.5% для п.1 и п. 3 и 95% для п. 2.

# 4. Информация о субъектах

## 4.1 Описательные статистики согласно протоколу

```{r descr_stats}

data_summary <- data %>%
  mutate_if(is.character, as.factor) %>%
  mutate(
    V0_DEM_GEN = factor("Женщина"),
    V0_DEM_AGE = V0_DEM_AGE + 20
  ) %>%
   mutate_at(vars(contains('NORM')), as.factor)%>%
   mutate_if(is.numeric, as.double)



# Cохранение таблицы в виде картинки
# gt::gtsave(as_gt(table_summary), file ='table_summary.png')

cv_table <- data_summary %>%
  summarise(across(where(is.numeric), ~sd(.) / mean(.), .names = "{.col}"))

print(cv_table)
statistics_table <- data_summary %>%
  summarise(
    median = median(V1_TIDES_AMOUNT),
    iqr = IQR(V1_TIDES_AMOUNT),
    mean = mean(V1_TIDES_AMOUNT),
    sd = sd(V1_TIDES_AMOUNT),
    min = min(V1_TIDES_AMOUNT),
    max = max(V1_TIDES_AMOUNT)
  )
print(statistics_table)

statistics_table <- data_summary %>%
  summarise(
    median = median(V1_CB_HCT),
    iqr = IQR(V1_CB_HCT),
    mean = mean(V1_CB_HCT),
    sd = sd(V1_CB_HCT),
    min = min(V1_CB_HCT),
    max = max(V1_CB_HCT)
  )
print(statistics_table)
```

```{r}
table_summary <- data_summary %>%
  select(-ID, -V1_TIDES_AMOUNT, -V1_CB_HCT) %>%
  tbl_summary(
    by = V0_GRP,
    type = list(
      all_continuous() ~ "continuous2",
      all_categorical() ~ "categorical"
    ),
    missing = "no",
    statistic = list(
      all_continuous() ~ c("{median}({IQR})", "{mean}±{sd}", "{min}; {max}"),
      all_categorical() ~ "{n}({p}%)"
    )
  ) %>% 
  add_overall() %>% 
  add_n() %>% 
#  add_p() %>% 
  add_ci() %>%
  modify_header(label = "**Переменные**") %>%   modify_footnote(
    all_stat_cols() ~ "Median (IQR), Mean±std, Min; Max, or N(Frequency)"
  ) 
table_summary
```



## 4.2 Различия групп после рандомизации по характеристикам

Переменные с одинаковыми значениями для всех пациентов, которые не подлежат сравнению: V0_DEM_GEN, V1_CB_MON., V1_CB_EO., V1_NORM_VIT, V2_CB_MON., V2_CB_EO., V2_NORM_ECG, V2_NORM_VIT


```{r}
v1_v0_num_columns <- names(data_filtered)[grepl("V1|V0", names(data_filtered)) & sapply(data_filtered, is.numeric)]

group_stats <- data_filtered %>%
  select(all_of(v1_v0_num_columns), V0_GRP) %>%
  pivot_longer(cols = all_of(v1_v0_num_columns), names_to = "переменная", values_to = "value") %>%
  group_by(переменная, V0_GRP) %>%
  summarise('Среднее по группам' = mean(value), 'Медиана по группам' = median(value), .groups = 'drop')

t_test_results <- data_filtered %>%
  select(all_of(v1_v0_num_columns), V0_GRP) %>%
  pivot_longer(cols = all_of(v1_v0_num_columns), names_to = "переменная", values_to = "value") %>%
  group_by(переменная) %>%
  do(tidy(t.test(value ~ V0_GRP, data = .)))

t_test_results$holm_adjusted_p <- p.adjust(t_test_results$p.value, method = "holm")
t_test_results$fdr_adjusted_p <- p.adjust(t_test_results$p.value, method = "fdr")

cat('Различающиеся колонки до поправок: ', paste((t_test_results %>%
  filter(p.value <= 0.05))$переменная, collapse = ', '), '\n')

cat('Различающиеся колонки после поправки Холма: ', paste((t_test_results %>%
  filter(holm_adjusted_p <= 0.05))$переменная, collapse = ', '), '\n')

t_test_results <- left_join(t_test_results, group_stats, by = "переменная")

write.csv(t_test_results, file = 't_test_results.csv')

print(t_test_results)
```

Таким образом, группы терапии статистически значимо не различаются по измеряемым численным показателям.

Для категориальных переменных сравнение представлено ниже:

```{r}
factor_columns <- names(data_filtered)[grepl("V1|V0", names(data_filtered)) & sapply(data_filtered, is.factor) & names(data_filtered) != 'V0_GRP']

filtered_columns <- factor_columns[sapply(data_filtered[factor_columns], function(x) length(unique(x)) > 1)]

# Применяем точный тест Фишера
fisher_results_df <- lapply(filtered_columns, function(var) {
  test_result <- fisher.test(table(data_filtered[[var]], data_filtered$V0_GRP))
  tidy(test_result) %>% mutate(variable = var)
}) %>% bind_rows()

fisher_results_df$holm_adjusted_p <- p.adjust(fisher_results_df$p.value, method = "holm")
fisher_results_df$bonferroni_adjusted_p <- p.adjust(fisher_results_df$p.value, method = "bonferroni")

write.csv(fisher_results_df, file = 'fisher_results_df.csv')

print(fisher_results_df)
```


# 5. Оценка эффективности 

Проведен тест на нормальность

```{r}
shapiro.test(data$V2_TIDES_AMOUNT)
```

Гипотезу о нормальном распределении переменной отвергнуть не можем (p-value = 0.1472). Далее исходим из допущения, что данная переменная распределена нормально. Также, исходя из литературных данных, используем допущение о равенстве дисперсий в выборках. 
Проведен односторонний t-test для независимых выборок с одинаковыми дисперсиями.


```{r}
# Разделение данных на две группы
group1 <- data %>% 
  filter(V0_GRP == "Мастодинон")
group2 <- data %>% 
  filter(V0_GRP == "Плацебо")

# Проведение t-теста
t_test_result <- t.test(group1$V2_TIDES_AMOUNT, group2$V2_TIDES_AMOUNT, var.equal = T, alternative = "less", mu = -2)

# Вывод результатов теста
print(t_test_result)
```
Статистически значимых различий между контрольной группой и группой плацебо не обнаружено (p-value = 0.9987).
Таким образом, первичная конечная точка не достигнута.


# 6. Оценка безопасности

Количественные переменные

```{r}
data <- read.csv2("../data/team_5.csv")
data_filtered <- data %>%
  mutate_if(is.character, as.factor) %>%
  mutate(
    V0_DEM_GEN = factor("ж"),
    V0_DEM_AGE = V0_DEM_AGE + 20
  ) %>%
   mutate_at(vars(contains('NORM')), as.factor)
head(data_filtered) 
```

```{r}
non_unique <- names(data_filtered)[sapply(data_filtered, function(x) length(unique(x)) == 1)]

cat('Колонки с одинаковыми значениями, которые не подлежат сравнению:', paste(non_unique, collapse = ', '), '\n')
```


 "CB_MON.", "CB_EO." не отличаются, проверка по ним не проводилась
 
Числовые переменные: проведен тест Уилкоксона для зависимых переменных.
Группа Мастодинона:  

```{r}
data_cleaned <- data_filtered
data_control <- data_cleaned %>%
  filter(V0_GRP == "Мастодинон")

names <- c("CB_WBC", "CB_RBC", "CB_HGB", "CB_HCT", 
           "CB_PLT", "CB_NEUT.", "CB_LYM.", "CB_BAS.")


# Создаем пустой датафрейм для сохранения результатов
wilcox_results_df <- data.frame()

for (name in names) {
  name_1 <- paste0("V1_", name)
  name_2 <- paste0("V2_", name)
  # Проводим тест и сохраняем результаты в датафрейме
  result <- data_control %>%
    select(ID, name_1, name_2) %>%
    pivot_longer(!ID) %>%
    wilcox_test(value ~ name, paired = TRUE, detailed = TRUE) 
  
  # Добавляем результаты к датафрейму
  wilcox_results_df <- bind_rows(wilcox_results_df, result)
}

# Выводим весь датафрейм с результатами тестов
wilcox_results_df %>% 
  select(group1, statistic, p, conf.low, conf.high)
```

Группа Плацебо:
 
```{r}
data_cleaned <- data_filtered
data_control <- data_cleaned %>%
  filter(V0_GRP == "Плацебо")

names <- c("CB_WBC", "CB_RBC", "CB_HGB", "CB_HCT", 
           "CB_PLT", "CB_NEUT.", "CB_LYM.", "CB_BAS.")


# Создаем пустой датафрейм для сохранения результатов
wilcox_results_df <- data.frame()

for (name in names) {
  name_1 <- paste0("V1_", name)
  name_2 <- paste0("V2_", name)
  # Проводим тест и сохраняем результаты в датафрейме
  result <- data_control %>%
    select(ID, name_1, name_2) %>%
    pivot_longer(!ID) %>%
    wilcox_test(value ~ name, paired = TRUE, detailed = TRUE) 
  
  # Добавляем результаты к датафрейму
  wilcox_results_df <- bind_rows(wilcox_results_df, result)
}

# Выводим весь датафрейм с результатами тестов
wilcox_results_df %>% 
  select(group1, statistic, p, conf.low, conf.high)
```


Переменные "CB_MON.", "CB_EO." в приведенных данных принимают только одно константное значение значение, проверка по ним не проводилась.

Данные по общему анализу крови до и после лечения в группе Мастандиона, как и в группе Плацебо, статистически значимо не отличаются.

Категориальные переменные

```{r}
#Сабсет с группой Мастодинона: 
data2 <- data_cleaned %>%
  filter(V0_GRP == "Мастодинон")

#ЭКГ в группе Мастодинона:
sopr2 <- data2 %>%       
  select(V1_NORM_ECG, V2_NORM_ECG)

sopr_ispravl <- matrix(c(sum(sopr2[,1] == 0 & sopr2[,2] == 0), sum(sopr2[,1] == 0 & sopr2[,2] == 1), sum(sopr2[,1] == 1 & sopr2[,2] == 0), sum(sopr2[,1] == 1 & sopr2[,2] == 1)), nrow = 2, ncol = 2, byrow = TRUE, dimnames = list(c("V1_ECG_NORM=0", "V1_ECG_NORM=1"), c("V2_ECG_NORM=0", "V2_ECG_NORM=1"))) %>% print()

mcn1 <- sopr_ispravl %>%
  mcnemar.test() %>%
  tidy()

#Физикальный осмотр в группе Мастодинона:
sopr2 <- data2 %>%       
  select(V1_NORM_PHYS, V2_NORM_PHYS)

sopr_ispravl <- matrix(c(sum(sopr2[,1] == 0 & sopr2[,2] == 0), sum(sopr2[,1] == 0 & sopr2[,2] == 1), sum(sopr2[,1] == 1 & sopr2[,2] == 0), sum(sopr2[,1] == 1 & sopr2[,2] == 1)), nrow = 2, ncol = 2, byrow = TRUE, dimnames = list(c("V1_ECG_PHYS=0", "V1_ECG_PHYS=1"), c("V2_ECG_PHYS=0", "V2_ECG_PHYS=1"))) %>% print()

mcn2 <- sopr_ispravl %>%
  mcnemar.test() %>%
  tidy()

#Витальные показатели осмотр в группе Мастодинона:
sopr2 <- data2 %>%       
  select(V1_NORM_VIT, V2_NORM_VIT)

sopr_ispravl <- matrix(c(sum(sopr2[,1] == 0 & sopr2[,2] == 0), sum(sopr2[,1] == 0 & sopr2[,2] == 1), sum(sopr2[,1] == 1 & sopr2[,2] == 0), sum(sopr2[,1] == 1 & sopr2[,2] == 1)), nrow = 2, ncol = 2, byrow = TRUE, dimnames = list(c("V1_ECG_VIT=0", "V1_ECG_VIT=1"), c("V2_ECG_VIT=0", "V2_ECG_VIT=1"))) %>% print()

mcn3 <- sopr_ispravl %>%
  mcnemar.test() %>%
  tidy()

#Сабсет с группой Плацебо: 
data3 <- data_cleaned %>%
  filter(V0_GRP == "Плацебо")

#ЭКГ в группе Плацебо:
sopr3 <- data3 %>%       
  select(V1_NORM_ECG, V2_NORM_ECG)

sopr_ispravl <- matrix(c(sum(sopr3[,1] == 0 & sopr3[,2] == 0), sum(sopr3[,1] == 0 & sopr3[,2] == 1), sum(sopr3[,1] == 1 & sopr3[,2] == 0), sum(sopr3[,1] == 1 & sopr3[,2] == 1)), nrow = 2, ncol = 2, byrow = TRUE, dimnames = list(c("V1_ECG_NORM=0", "V1_ECG_NORM=1"), c("V2_ECG_NORM=0", "V2_ECG_NORM=1"))) %>% print()

mcn4 <- sopr_ispravl %>%
  mcnemar.test() %>%
  tidy()

#Физикальный осмотр в группе Плацебо:
sopr3 <- data3 %>%       
  select(V1_NORM_PHYS, V2_NORM_PHYS)

sopr_ispravl <- matrix(c(sum(sopr3[,1] == 0 & sopr3[,2] == 0), sum(sopr3[,1] == 0 & sopr3[,2] == 1), sum(sopr3[,1] == 1 & sopr3[,2] == 0), sum(sopr3[,1] == 1 & sopr3[,2] == 1)), nrow = 2, ncol = 2, byrow = TRUE, dimnames = list(c("V1_ECG_PHYS=0", "V1_ECG_PHYS=1"), c("V2_ECG_PHYS=0", "V2_ECG_PHYS=1"))) %>% print()

mcn5 <- sopr_ispravl %>%
  mcnemar.test() %>%
  tidy()

#Витальные показатели осмотр в группе Плацебо:
sopr3 <- data3 %>%       
  select(V1_NORM_VIT, V2_NORM_VIT)

sopr_ispravl <- matrix(c(sum(sopr3[,1] == 0 & sopr3[,2] == 0), sum(sopr3[,1] == 0 & sopr3[,2] == 1), sum(sopr3[,1] == 1 & sopr3[,2] == 0), sum(sopr3[,1] == 1 & sopr3[,2] == 1)), nrow = 2, ncol = 2, byrow = TRUE, dimnames = list(c("V1_ECG_VIT=0", "V1_ECG_VIT=1"), c("V2_ECG_VIT=0", "V2_ECG_VIT=1"))) %>% print()

mcn6 <- sopr_ispravl %>%
  mcnemar.test() %>%
  tidy()

# Создайте список из ваших датафреймов
df_list <- list(mcn1, mcn2, mcn3, mcn4, mcn5, mcn6)

# Объедините датафреймы по строкам
combined_df <- bind_rows(df_list)

# Посмотрите на объединенный датафрейм
print(combined_df)
```

Данные по ЭКГ, физикальному осмотру и оценке жизненно-важных показателей до и после лечения в группе Мастандиона, как и в группе Плацебо, статистически значимо не отличаются.

Сравнение численных характеристик по группам на визит 2 

```{r}
non_unique <- names(data_filtered)[sapply(data_filtered, function(x) length(unique(x)) == 1)]

data_filtered <- data_filtered %>% select(-all_of(non_unique))
v2_num_columns <- names(data_filtered)[grepl("V2", names(data_filtered)) & sapply(data_filtered, is.numeric)]

group_stats <- data_filtered %>%
  select(all_of(v2_num_columns), V0_GRP) %>%
  pivot_longer(cols = all_of(v2_num_columns), names_to = "переменная", values_to = "value") %>%
  group_by(переменная, V0_GRP) %>%
  summarise('Среднее по группам' = mean(value), 'Медиана по группам' = median(value), .groups = 'drop')

t_test_results <- data_filtered %>%
  select(all_of(v2_num_columns), V0_GRP) %>%
  pivot_longer(cols = all_of(v2_num_columns), names_to = "переменная", values_to = "value") %>%
  group_by(переменная) %>%
  do(tidy(t.test(value ~ V0_GRP, data = .)))

t_test_results$holm_adjusted_p <- p.adjust(t_test_results$p.value, method = "holm")
t_test_results$fdr_adjusted_p <- p.adjust(t_test_results$p.value, method = "fdr")

cat('Различающиеся колонки до поправок: ', paste((t_test_results %>%
  filter(p.value <= 0.05))$переменная, collapse = ', '), '\n')

cat('Различающиеся колонки после поправки Холма: ', paste((t_test_results %>%
  filter(holm_adjusted_p <= 0.05))$переменная, collapse = ', '), '\n')

t_test_results <- left_join(t_test_results, group_stats, by = "переменная")

write.csv(fisher_results_df, file = 't_test_results_v2.csv')

print(t_test_results)
```

Сравнение категориальных характеристик по группам на визит 2 

```{r}
factor_columns <- names(data_filtered)[grepl("V2", names(data_filtered)) & sapply(data_filtered, is.factor) & names(data_filtered) != 'V0_GRP']

filtered_columns <- factor_columns[sapply(data_filtered[factor_columns], function(x) length(unique(x)) > 1)]

# Применяем точный тест Фишера
fisher_results_df <- lapply(filtered_columns, function(var) {
  test_result <- fisher.test(table(data_filtered[[var]], data_filtered$V0_GRP))
  tidy(test_result) %>% mutate(variable = var)
}) %>% bind_rows()

fisher_results_df$holm_adjusted_p <- p.adjust(fisher_results_df$p.value, method = "holm")
fisher_results_df$bonferroni_adjusted_p <- p.adjust(fisher_results_df$p.value, method = "bonferroni")
fisher_results_df
```



Заключение:
Клинически значимых нежелательных явлений при применении препарата Мастодинон по 40 кап перед завтраком в течение 4 недель по сравнению с Плацебо не получено.

# 7. Обсуждение и общее заключение

По результатам настоящего исследования не получено данных, подтверждающих эффективность препарата Мастодинон по сравнению с плацебо (первичная конечная точка не достигнута). Также при применении препарата Мастодинон не получено клинически значимых нежелательных явлений, связанных/не связанных с применением препарата, в том числе требовавших прекращения терапии. 
Таким образом, по результатам настоящего исследования судить о возможности расширения показания для препарата (применение при постменопаузальном синдроме) не представляется возможным.



